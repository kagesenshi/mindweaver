name: Build and Push Hive Metastore Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - "helm/hive-metastore/**"
  pull_request:
    branches:
      - main
    paths:
      - "helm/hive-metastore/**"
  workflow_dispatch:
    inputs:
      push-package:
        description: "Push Helm chart to registry"
        required: true
        type: boolean
        default: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Update Helm dependencies
        run: |
          cd helm/hive-metastore
          helm dependency update

      - name: Lint Helm chart
        run: helm lint helm/hive-metastore

      - name: Package Helm chart
        run: |
          VERSION=$(cat images/hive-metastore/VERSION.txt)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          cd helm/hive-metastore
          helm package . --version "${VERSION}-alpha.${TIMESTAMP}" --app-version "${VERSION}-alpha.${TIMESTAMP}"

      - name: Push Helm chart to GHCR
        if: github.event_name == 'workflow_dispatch' && inputs.push-package == true
        run: |
          cd helm/hive-metastore
          CHART_PACKAGE=$(ls hive-metastore-*.tgz)
          helm push "$CHART_PACKAGE" oci://ghcr.io/${{ github.repository_owner }}/mindweaver/charts
